{% extends 'base.html' %}
{% load humanize %}

{% block title %}Dashboard - Akilimo Nigeria Association{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="page-title">
                <span class="material-icons">dashboard</span>
                Dashboard Overview
            </h1>
            <p class="page-subtitle">
                Welcome to the Akilimo Nigeria Association dashboard.
            </p>
        </div>
        <!-- Country Selector -->
        <div class="country-selector">
            <label for="countrySelect" class="form-label mb-1">Select Country:</label>
            <select id="countrySelect" class="form-select" onchange="changeCountry(this.value)">
                <option value="all" {% if selected_country == 'all' %}selected{% endif %}>
                    All Countries ({{ total_participants|intcomma }} participants)
                </option>
                {% for country in available_countries %}
                <option value="{{ country.country }}" {% if country.country == selected_country %}selected{% endif %}>
                    {{ country.country|title }} ({{ country.count|intcomma }} participants)
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- Enhanced Key Metrics Cards -->
<div class="row g-4 mb-5">
    <div class="col-xl-3 col-md-6">
        <div class="metric-card">
            <div class="metric-icon">
                <span class="material-icons">people</span>
            </div>
            <div class="metric-label">Total Farmers</div>
            <div class="metric-value">{{ total_participants|default:0|intcomma }}</div>
            <div class="metric-detail">
                <span class="material-icons me-1">male</span>{{ male_count|default:0|intcomma }}
                <span class="material-icons me-1 ms-2">female</span>{{ female_count|default:0|intcomma }}
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card">
            <div class="metric-icon">
                <span class="material-icons">location_on</span>
            </div>
            <div class="metric-label">Geographic Reach</div>
            <div class="metric-value">{{ total_states_count|default:0|intcomma }}</div>
            <div class="metric-detail">States covered</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card">
            <div class="metric-icon">
                <span class="material-icons">phone</span>
            </div>
            <div class="metric-label">Connected Farmers</div>
            <div class="metric-value">{{ farmers_with_phones|default:0|intcomma }}</div>
            <div class="metric-detail">With phone numbers</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card">
            <div class="metric-icon">
                <span class="material-icons">event</span>
            </div>
            <div class="metric-label">Training Events</div>
            <div class="metric-value">{{ unique_events|default:0|intcomma }}</div>
            <div class="metric-detail">Unique sessions</div>
        </div>
    </div>
</div>

<!-- Additional Metrics Row -->
<div class="row g-4 mb-5">
    <div class="col-xl-3 col-md-6">
        <div class="metric-card secondary">
            <div class="metric-icon">
                <span class="material-icons">location_city</span>
            </div>
            <div class="metric-label">Cities Reached</div>
            <div class="metric-value">{{ total_cities_count|default:0|intcomma }}</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card secondary">
            <div class="metric-icon">
                <span class="material-icons">eco</span>
            </div>
            <div class="metric-label">Crop Types</div>
            <div class="metric-value">{{ crop_stats|length|intcomma }}</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card secondary">
            <div class="metric-icon">
                <span class="material-icons">business</span>
            </div>
            <div class="metric-label">Partner Organizations</div>
            <div class="metric-value">{{ total_partner_organizations|default:0|intcomma }}</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card secondary">
            <div class="metric-icon">
                <span class="material-icons">support_agent</span>
            </div>
            <div class="metric-label">Extension Agents</div>
            <div class="metric-value">{{ extension_agents|default:0|intcomma }}</div>
        </div>
    </div>
</div>

<!-- Enhanced Charts Section -->
<div class="row g-4 mb-5">
    <!-- Gender Distribution -->
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <span class="material-icons">wc</span>
                    Gender Distribution
                </h5>
            </div>
            <div class="chart-body">
                <div style="position: relative; height: 300px;">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Crops -->
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <span class="material-icons">eco</span>
                    Top Crops
                </h5>
            </div>
            <div class="chart-body">
                <div style="position: relative; height: 300px;">
                    <canvas id="cropChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monthly Trend -->
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <span class="material-icons">trending_up</span>
                    Monthly Participation
                </h5>
            </div>
            <div class="chart-body">
                <div style="position: relative; height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Geographic and Partner Charts -->
<div class="row g-4 mb-5">
    <!-- Top States -->
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <span class="material-icons">map</span>
                    Top States
                </h5>
            </div>
            <div class="chart-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="statesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Cities -->
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <span class="material-icons">location_city</span>
                    Top Cities
                </h5>
            </div>
            <div class="chart-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="cityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Partners -->
    <div class="col-lg-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <span class="material-icons">business</span>
                    Top Partners
                </h5>
            </div>
            <div class="chart-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="partnerChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activities -->
<div class="row">
    <div class="col-12">
        <div class="table-container">
            <div class="chart-header">
                <h5 class="chart-title">
                    <span class="material-icons">schedule</span>
                    Recent Training Sessions
                </h5>
            </div>
            <div class="table-responsive">
                {% if recent_trainings %}
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Participant ID</th>
                                <th>Location</th>
                                <th>State</th>
                                <th>Training Date</th>
                                <th>Facilitator</th>
                                <th>Event Type</th>
                                <th>Farm Size</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for training in recent_trainings %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" 
                                             style="width: 32px; height: 32px;">
                                            <span class="material-icons text-white" style="font-size: 16px;">person</span>
                                        </div>
                                        <strong>{{ training.external_id }}</strong>
                                    </div>
                                </td>
                                <td>{{ training.location|default:"-" }}</td>
                                <td>
                                    {% if training.state %}
                                        <span class="badge bg-primary">{{ training.state }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if training.training_date %}
                                        <div class="d-flex align-items-center">
                                            <span class="material-icons text-success me-1" style="font-size: 16px;">event</span>
                                            {{ training.training_date|date:"M d, Y" }}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ training.facilitator|default:"-" }}</td>
                                <td>
                                    {% if training.event_type %}
                                        <span class="badge bg-success">{{ training.event_type }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if training.farm_size %}
                                        <div class="d-flex align-items-center">
                                            <span class="material-icons text-success me-1" style="font-size: 16px;">agriculture</span>
                                            {{ training.farm_size|floatformat:1|intcomma }} ha
                                        </div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <span class="material-icons text-muted" style="font-size: 64px;">event_busy</span>
                        </div>
                        <h5 class="text-muted mb-2">No Recent Training Sessions</h5>
                        <p class="text-muted">No training sessions found. Try syncing data from the API.</p>
                        <button class="btn btn-primary" onclick="syncData(event)">
                            <span class="material-icons me-2">sync</span>
                            Sync Data Now
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced color palettes
    const greenPalette = [
        '#2E7D32', '#4CAF50', '#66BB6A', '#81C784', '#A5D6A7',
        '#388E3C', '#43A047', '#689F38', '#827717', '#558B2F'
    ];
    
    const diversePalette = [
        '#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336',
        '#00BCD4', '#FFEB3B', '#795548', '#607D8B', '#E91E63'
    ];
    
    // Ensure Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Cannot create charts.');
        return;
    }

    // Gender Distribution Chart
    const genderData = {{ gender_stats|safe }};
    if (genderData.length > 0) {
        const genderLabels = genderData.map(item => item.gender || 'Unknown');
        const genderCounts = genderData.map(item => item.count);
        
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: genderLabels,
                datasets: [{
                    data: genderCounts,
                    backgroundColor: greenPalette.slice(0, genderLabels.length),
                    borderWidth: 0,
                    hoverBorderWidth: 2,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: { family: 'Roboto', size: 11 }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }

    // Crop Distribution Chart
    const cropData = {{ crop_stats|safe }};
    if (cropData.length > 0) {
        const cropLabels = cropData.map(item => item.crop || 'Unknown');
        const cropCounts = cropData.map(item => item.count);
        
        const cropCtx = document.getElementById('cropChart').getContext('2d');
        new Chart(cropCtx, {
            type: 'pie',
            data: {
                labels: cropLabels,
                datasets: [{
                    data: cropCounts,
                    backgroundColor: diversePalette.slice(0, cropLabels.length),
                    borderWidth: 0,
                    hoverBorderWidth: 2,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            usePointStyle: true,
                            font: { family: 'Roboto', size: 10 }
                        }
                    }
                }
            }
        });
    }

    // Monthly Trend Chart
    const trendData = {{ monthly_trend|safe }};
    if (trendData.length > 0) {
        const trendLabels = trendData.map(item => item.month.split(' ')[0]);
        const trendCounts = trendData.map(item => item.count);
        
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Farmers',
                    data: trendCounts,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#4CAF50',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font: { family: 'Roboto' }, color: '#757575' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { family: 'Roboto' }, color: '#757575' }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // States Distribution Chart
    const statesData = {{ state_stats|safe }};
    if (statesData.length > 0) {
        const stateLabels = statesData.map(item => item.state || 'Unknown');
        const stateCounts = statesData.map(item => item.count);
        
        const statesCtx = document.getElementById('statesChart').getContext('2d');
        new Chart(statesCtx, {
            type: 'bar',
            data: {
                labels: stateLabels,
                datasets: [{
                    label: 'Farmers',
                    data: stateCounts,
                    backgroundColor: '#2196F3',
                    borderColor: '#1976D2',
                    borderWidth: 0,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font: { family: 'Roboto' }, color: '#757575' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { 
                            font: { family: 'Roboto' }, 
                            color: '#757575',
                            maxRotation: 45
                        }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Cities Distribution Chart
    const cityData = {{ city_stats|safe }};
    if (cityData.length > 0) {
        const cityLabels = cityData.map(item => item.event_city || 'Unknown');
        const cityCounts = cityData.map(item => item.count);
        
        const cityCtx = document.getElementById('cityChart').getContext('2d');
        new Chart(cityCtx, {
                type: 'bar',
                data: {
                    labels: cityLabels,
                    datasets: [{
                        label: 'Farmers',
                        data: cityCounts,
                        backgroundColor: '#FF9800',
                        borderColor: '#F57C00',
                        borderWidth: 0,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { family: 'Roboto' }, color: '#757575' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { font: { family: 'Roboto' }, color: '#757575' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
        });
    }

    // Partners Distribution Chart
    const partnerData = {{ partner_stats|safe }};
    if (partnerData.length > 0) {
        const partnerLabels = partnerData.map(item => (item.partner || 'Unknown').substring(0, 20) + '...');
        const partnerCounts = partnerData.map(item => item.count);
        
        const partnerCtx = document.getElementById('partnerChart').getContext('2d');
        new Chart(partnerCtx, {
                type: 'bar',
                data: {
                    labels: partnerLabels,
                    datasets: [{
                        label: 'Farmers',
                        data: partnerCounts,
                        backgroundColor: '#9C27B0',
                        borderColor: '#7B1FA2',
                        borderWidth: 0,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { family: 'Roboto' }, color: '#757575' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                font: { family: 'Roboto' }, 
                                color: '#757575',
                                maxRotation: 45
                            }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
        });
    }

    // Add loading animation to metric cards
    const metricCards = document.querySelectorAll('.metric-card');
    metricCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }, index * 50);
    });

}); // End DOMContentLoaded

// Country selector function
function changeCountry(selectedCountry) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('country', selectedCountry);
    window.location.href = currentUrl.toString();
}
</script>

<style>
.country-selector {
    min-width: 300px;
}

.country-selector .form-select {
    font-size: 0.9rem;
    border: 1px solid #28a745;
    border-radius: 8px;
}

.country-selector .form-select:focus {
    border-color: #20a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.country-selector .form-label {
    font-weight: 600;
    color: #28a745;
    font-size: 0.85rem;
}

.metric-detail {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 8px;
    display: flex;
    align-items: center;
}

.metric-card.secondary {
    border-left-color: #2196F3;
}

.metric-card.secondary .metric-icon {
    background: linear-gradient(135deg, #2196F3, #1976D2);
}
</style>
{% endblock %}