{% extends 'base.html' %}
{% load humanize %}

{% block title %}Membership Subscription - AKILIMO Dashboard{% endblock %}

{% block extra_head %}
<!-- Paystack JavaScript SDK -->
<script src="https://js.paystack.co/v1/inline.js"></script>
{% endblock %}

{% block content %}
<div class="page-header mb-5">
    <h1 class="page-title">
        <span class="material-icons">card_membership</span>
        ANA Membership Subscription
    </h1>
    <p class="page-subtitle">Join the AKILIMO Nigeria Association and unlock exclusive benefits</p>
</div>

{% if user_has_active_membership %}
<!-- Current Membership Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success" role="alert">
            <div class="d-flex align-items-center">
                <span class="material-icons me-3" style="font-size: 2rem;">verified</span>
                <div>
                    <h5 class="alert-heading mb-1">Active Membership</h5>
                    <p class="mb-0">You currently have an active {{ membership.get_membership_type_display }} membership valid until {{ membership.end_date|date:"M d, Y" }}.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Membership Plans -->
<div class="row g-4 mt-5 mb-5 justify-content-center">
    <!-- Individual Membership -->
    <div class="col-md-4">
        <div class="pricing-card {% if membership.membership_type == 'individual' %}active{% endif %}">
            <div class="pricing-header">
                <div class="pricing-icon">
                    <span class="material-icons">person</span>
                </div>
                <h3>Individual Membership</h3>
                <p class="text-muted">Perfect for individual farmers and professionals</p>
            </div>
            <div class="pricing-price">
                <span class="currency">₦</span>
                <span class="amount">{{ pricing.individual|floatformat:0|intcomma }}</span>
                <span class="period">/year</span>
            </div>
            <ul class="pricing-features">
                <li><span class="material-icons">check</span>Full dashboard access</li>
                <li><span class="material-icons">check</span>Analytics and insights</li>
                <li><span class="material-icons">check</span>Digital certificate</li>
                <li><span class="material-icons">check</span>ID card download</li>
                <li><span class="material-icons">check</span>Training materials</li>
                <li><span class="material-icons">check</span>Email support</li>
                <li><span class="material-icons">check</span>Monthly newsletters</li>
                <li><span class="material-icons">check</span>Access to events</li>
            </ul>
            <div class="membership-countdown mb-3">
                {% if user_has_active_membership and membership.membership_type == 'individual' %}
                    <div class="countdown-info">
                        <small class="text-muted">Membership expires in:</small>
                        <div class="countdown-days">{{ membership.days_remaining }} days</div>
                    </div>
                {% endif %}
            </div>
            <button class="btn btn-primary btn-subscribe" 
                    data-membership="individual" 
                    data-amount="{{ pricing.individual }}">
                Join as Individual - ₦{{ pricing.individual|floatformat:0|intcomma }}
            </button>
        </div>
    </div>

    <!-- Organization Membership -->
    <div class="col-md-4">
        <div class="pricing-card premium {% if membership.membership_type == 'organization' %}active{% endif %}">
            <div class="pricing-badge">For Organizations</div>
            <div class="pricing-header">
                <div class="pricing-icon">
                    <span class="material-icons">business</span>
                </div>
                <h3>Organization Membership</h3>
                <p class="text-muted">For partner organizations and cooperatives</p>
            </div>
            <div class="pricing-price">
                <span class="currency">₦</span>
                <span class="amount">{{ pricing.organization|floatformat:0|intcomma }}</span>
                <span class="period">/year</span>
            </div>
            <ul class="pricing-features">
                <li><span class="material-icons">check</span>Everything in Individual</li>
                <li><span class="material-icons">check</span>Priority support</li>
                <li><span class="material-icons">check</span>Advanced analytics</li>
                <li><span class="material-icons">check</span>Multiple user access</li>
                <li><span class="material-icons">check</span>Custom training programs</li>
                <li><span class="material-icons">check</span>Dedicated account manager</li>
                <li><span class="material-icons">check</span>API access</li>
                <li><span class="material-icons">check</span>Bulk member registration</li>
            </ul>
            <div class="membership-countdown mb-3">
                {% if user_has_active_membership and membership.membership_type == 'organization' %}
                    <div class="countdown-info">
                        <small class="text-muted">Membership expires in:</small>
                        <div class="countdown-days">{{ membership.days_remaining }} days</div>
                    </div>
                {% endif %}
            </div>
            <button class="btn btn-primary btn-subscribe" 
                    data-membership="organization" 
                    data-amount="{{ pricing.organization }}">
                Join as Organization - ₦{{ pricing.organization|floatformat:0|intcomma }}
            </button>
        </div>
    </div>
</div>

<!-- Benefits Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="benefits-section">
            <h2 class="text-center mb-5">Why Join ANA?</h2>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon">
                            <span class="material-icons">school</span>
                        </div>
                        <h5>Expert Training</h5>
                        <p>Access to world-class agricultural training and resources</p>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon">
                            <span class="material-icons">groups</span>
                        </div>
                        <h5>Community Network</h5>
                        <p>Connect with fellow farmers and agricultural professionals</p>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon">
                            <span class="material-icons">analytics</span>
                        </div>
                        <h5>Data-Driven Insights</h5>
                        <p>Advanced analytics to improve your farming decisions</p>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon">
                            <span class="material-icons">support_agent</span>
                        </div>
                        <h5>Expert Support</h5>
                        <p>Get help from agricultural experts when you need it</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Confirmation Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">payment</span>
                    Confirm Payment
                </h5>
                <button type="button" class="btn-close" id="modalCloseBtn" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Payment Summary Section -->
                <div class="payment-summary-header p-4 bg-light">
                    <h6 class="mb-3 text-success">
                        <span class="material-icons me-2" style="font-size: 20px;">receipt_long</span>
                        Payment Summary
                    </h6>
                    <div class="summary-row">
                        <span class="summary-label">Membership Type:</span>
                        <span id="modalMembershipType" class="summary-value"></span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Amount:</span>
                        <span id="modalAmount" class="summary-value text-success fw-bold"></span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Email:</span>
                        <span class="summary-value text-muted">{{ user.email }}</span>
                    </div>
                </div>
                
                <!-- Payment Method Section -->
                <div class="payment-method-section p-4">
                    <h6 class="mb-3 text-dark">
                        <span class="material-icons me-2" style="font-size: 20px;">payment</span>
                        Payment Method
                    </h6>
                    
                    <div class="paystack-card">
                        <div class="paystack-header">
                            <div class="paystack-logo me-3">
                                <span class="material-icons">credit_card</span>
                            </div>
                            <div class="paystack-info">
                                <div class="paystack-title">Paystack</div>
                                <div class="paystack-subtitle">Secure Payment Gateway</div>
                            </div>
                        </div>
                        
                        <div class="security-info">
                            <span class="material-icons me-2">security</span>
                            <span>256-bit SSL encryption • PCI DSS compliant</span>
                        </div>
                        
                        <div class="accepted-methods">
                            <small class="text-muted">Accepts: Cards, Bank Transfer, USSD, Mobile Money</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="modalCancelBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="proceedPaymentBtn">
                    <span class="material-icons me-1">credit_card</span>
                    Pay Now
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Payment Modal Styling */
.payment-summary-header {
    border-bottom: 1px solid #e9ecef;
}

.payment-summary-header h6 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f8f9fa;
}

.summary-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.summary-label {
    font-weight: 500;
    color: #6c757d;
    font-size: 0.9rem;
}

.summary-value {
    font-weight: 600;
    font-size: 0.95rem;
}

.payment-method-section h6 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.paystack-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1.25rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    transition: all 0.3s ease;
}

.paystack-card:hover {
    border-color: #28a745;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.1);
}

.paystack-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.paystack-logo {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #0fa958, #15c96b);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.paystack-info {
    flex: 1;
}

.paystack-title {
    font-weight: 600;
    font-size: 1.1rem;
    color: #212529;
    margin-bottom: 0.25rem;
}

.paystack-subtitle {
    font-size: 0.85rem;
    color: #6c757d;
}

.security-info {
    display: flex;
    align-items: center;
    background: #e8f5e9;
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    font-size: 0.85rem;
    font-weight: 500;
    color: #2e7d32;
}

.security-info .material-icons {
    font-size: 18px;
    color: #4caf50;
}

.accepted-methods {
    text-align: center;
    padding-top: 0.5rem;
    border-top: 1px solid #e9ecef;
}

.modal-content {
    border: none;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    overflow: hidden;
}

.modal-header {
    background: linear-gradient(135deg, #28a745, #34ce57);
    color: white;
    border-bottom: none;
    padding: 1.5rem;
}

.modal-header .modal-title {
    font-weight: 600;
    font-size: 1.25rem;
}

.modal-header .btn-close {
    filter: invert(1);
    opacity: 0.8;
    background: none;
    border: none;
    font-size: 1.25rem;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-header .btn-close:hover {
    opacity: 1;
    transform: scale(1.1);
}

.modal-header .btn-close:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
}

.modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 1.25rem 1.5rem;
    background: #f8f9fa;
}

.btn-success {
    background: linear-gradient(135deg, #28a745, #34ce57);
    border: none;
    padding: 0.75rem 2rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-success:hover {
    background: linear-gradient(135deg, #218838, #2bb544);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(40, 167, 69, 0.3);
}

.btn-secondary {
    background: #6c757d;
    border: none;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

#processingModal .modal-content {
    border-radius: 15px;
}

#processingModal .spinner-border {
    width: 3rem;
    height: 3rem;
}

/* Pricing Card Styles */
.pricing-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.pricing-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}

.pricing-card.premium {
    border: 2px solid var(--light-green);
    transform: scale(1.05);
}

.pricing-card.premium:hover {
    transform: scale(1.05) translateY(-8px);
}

.pricing-card.active {
    border: 2px solid var(--primary-green);
    background: linear-gradient(135deg, #E8F5E8 0%, white 100%);
}

.pricing-badge {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--light-green), var(--primary-green));
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
}

.pricing-header {
    text-align: center;
    margin-bottom: 2rem;
}

.pricing-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--light-green), var(--accent-green));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
}

.pricing-icon .material-icons {
    font-size: 32px;
    color: white;
}

.pricing-header h3 {
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.pricing-price {
    text-align: center;
    margin-bottom: 2rem;
}

.pricing-price .currency {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-secondary);
    vertical-align: top;
}

.pricing-price .amount {
    font-size: 3rem;
    font-weight: 700;
    color: var(--primary-green);
}

.pricing-price .period {
    font-size: 1rem;
    color: var(--text-secondary);
}

.pricing-features {
    list-style: none;
    padding: 0;
    margin-bottom: 2rem;
    flex-grow: 1;
}

.pricing-features li {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
}

.pricing-features .material-icons {
    font-size: 18px;
    margin-right: 0.75rem;
    width: 18px;
}

.pricing-features .material-icons.check {
    color: var(--success-green);
}

.pricing-features .material-icons.close {
    color: var(--text-secondary);
}

.btn-subscribe {
    width: 100%;
    padding: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 8px;
    margin-top: auto;
    cursor: pointer;
    position: relative;
    z-index: 10;
}

.btn-subscribe:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.benefits-section {
    background: linear-gradient(135deg, #F0F8F0 0%, white 100%);
    padding: 4rem 2rem;
    border-radius: 16px;
}

.benefit-card {
    text-align: center;
    padding: 2rem 1rem;
}

.benefit-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--primary-green), var(--light-green));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
}

.benefit-icon .material-icons {
    font-size: 32px;
    color: white;
}

.benefit-card h5 {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.benefit-card p {
    color: var(--text-secondary);
    margin-bottom: 0;
}

.membership-countdown {
    text-align: center;
}

.countdown-info {
    background: linear-gradient(135deg, #E8F5E8, #F0F8F0);
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid var(--accent-green);
}

.countdown-days {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-green);
    margin-top: 0.25rem;
}

.countdown-expired {
    background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
    border-color: #F44336;
}

.countdown-expired .countdown-days {
    color: #D32F2F;
}

.countdown-warning {
    background: linear-gradient(135deg, #FFF8E1, #FFECB3);
    border-color: #FF9800;
}

.countdown-warning .countdown-days {
    color: #F57C00;
}

@media (max-width: 768px) {
    .pricing-card.premium {
        transform: none;
    }
    
    .pricing-card.premium:hover {
        transform: translateY(-8px);
    }
    
    .countdown-days {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if MDB (Material Design Bootstrap) is loaded
    if (typeof mdb === 'undefined') {
        return;
    }
    
    // Debug: Log pricing data
    const pricingData = {{ pricing_json|safe }};
    
    // Check if Paystack is loaded, load if needed
    if (typeof PaystackPop === 'undefined') {
        const paystackScript = document.createElement('script');
        paystackScript.src = 'https://js.paystack.co/v1/inline.js';
        document.head.appendChild(paystackScript);
    }
    
    const subscribeButtons = document.querySelectorAll('.btn-subscribe');
    
    // Check if modal elements exist
    const paymentModalElement = document.getElementById('paymentModal');
    
    if (!paymentModalElement) {
        return;
    }
    
    const paymentModal = new mdb.Modal(paymentModalElement);
    
    let currentPaymentData = {};
    
    // Handle subscription button clicks
    subscribeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const membershipType = this.getAttribute('data-membership');
            const amountStr = this.getAttribute('data-amount');
            
            // Parse amount more safely - remove commas first
            let cleanAmountStr = amountStr ? amountStr.toString().replace(/,/g, '') : '0';
            let amount = parseFloat(cleanAmountStr);
            
            // Debug logging
            console.log('Raw amount string:', amountStr);
            console.log('Cleaned amount string:', cleanAmountStr);
            console.log('Parsed amount:', amount);
            console.log('Pricing data:', pricingData);
            
            if (isNaN(amount) || amount <= 0) {
                // Fallback to default pricing
                amount = membershipType === 'individual' ? pricingData.individual : pricingData.organization;
                console.log('Using fallback amount:', amount);
            }
            
            // Store payment data
            currentPaymentData = {
                membershipType: membershipType,
                amount: amount,
                email: '{{ user.email }}',
                memberDisplayName: membershipType === 'individual' ? 'Individual Membership' : 'Partner Organization Membership'
            };
            
            // Update modal content
            const modalMembershipType = document.getElementById('modalMembershipType');
            const modalAmount = document.getElementById('modalAmount');
            
            if (modalMembershipType && modalAmount) {
                modalMembershipType.textContent = currentPaymentData.memberDisplayName;
                
                // Format amount properly with Nigerian locale
                const formattedAmount = new Intl.NumberFormat('en-NG', {
                    style: 'currency',
                    currency: 'NGN',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
                
                modalAmount.textContent = formattedAmount;
                
                console.log('Final formatted amount:', formattedAmount);
            }
            
            // Show payment modal
            paymentModal.show();
        });
    });
    
    // Handle payment confirmation
    document.getElementById('proceedPaymentBtn').addEventListener('click', function() {
        paymentModal.hide();
        
        // Initialize payment with backend directly (no processing modal)
        initiatePayment(currentPaymentData);
    });
    
    // Handle modal close button (X)
    document.getElementById('modalCloseBtn').addEventListener('click', function() {
        paymentModal.hide();
        showPaymentCancelled();
    });
    
    // Handle cancel button
    document.getElementById('modalCancelBtn').addEventListener('click', function() {
        paymentModal.hide();
        showPaymentCancelled();
    });
    
    // Handle modal backdrop click and escape key
    paymentModalElement.addEventListener('hidden.mdb.modal', function() {
        // Clear payment data when modal is fully closed
        currentPaymentData = {};
    });
    
    // Handle backdrop click to close modal
    paymentModalElement.addEventListener('click', function(e) {
        if (e.target === paymentModalElement) {
            paymentModal.hide();
            showPaymentCancelled();
        }
    });
    
    // Handle escape key to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && paymentModalElement.classList.contains('show')) {
            paymentModal.hide();
            showPaymentCancelled();
        }
    });
    
    function waitForPaystack(callback, maxAttempts = 10, currentAttempt = 0) {
        if (typeof PaystackPop !== 'undefined') {
            callback();
        } else if (currentAttempt < maxAttempts) {
            setTimeout(() => {
                waitForPaystack(callback, maxAttempts, currentAttempt + 1);
            }, 500);
        } else {
            showPaymentError('Payment system failed to load. Please refresh the page and try again.');
        }
    }
    
    function initiatePayment(paymentData) {
        
        fetch('{% url "dashboard:initiate_payment" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                membership_type: paymentData.membershipType,
                amount: paymentData.amount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.public_key && data.reference) {
                waitForPaystack(() => {
                    let handler = PaystackPop.setup({
                    key: data.public_key,
                    email: paymentData.email,
                    amount: paymentData.amount * 100, // Convert to kobo
                    currency: 'NGN',
                    ref: data.reference,
                    metadata: {
                        membership_id: data.membership_id,
                        membership_type: paymentData.membershipType
                    },
                    callback: function(response) {
                        showPaymentSuccess(response);
                        setTimeout(() => {
                            window.location.href = '/dashboard/';
                        }, 3000);
                    },
                    onClose: function() {
                        showPaymentCancelled();
                    }
                });
                handler.openIframe();
                });
            } else {
                showPaymentError(data.error || 'Payment initialization failed');
            }
        })
        .catch(error => {
            showPaymentError('Payment request failed. Please try again.');
        });
    }
    
    function showPaymentSuccess(response) {
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        successDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        successDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <span class="material-icons me-2">check_circle</span>
                <div>
                    <strong>Payment Successful!</strong><br>
                    <small>Reference: ${response.reference}</small>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 5000);
    }
    
    function showPaymentCancelled() {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed';
        warningDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        warningDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <span class="material-icons me-2">info</span>
                <div>
                    <strong>Payment Cancelled</strong><br>
                    <small>You can try again anytime.</small>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(warningDiv);
        
        setTimeout(() => {
            if (warningDiv.parentNode) {
                warningDiv.remove();
            }
        }, 4000);
    }
    
    function showPaymentError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        errorDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <span class="material-icons me-2">error</span>
                <div>
                    <strong>Payment Failed</strong><br>
                    <small>${message}</small>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 6000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}