{% extends 'base.html' %}

{% block title %}
    {% if is_valid %}
        Membership Verified - {{ member_name }}
    {% else %}
        Membership Verification Failed
    {% endif %}
    - AKILIMO Dashboard
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <span class="material-icons">
            {% if is_valid %}verified{% elif found %}warning{% else %}error{% endif %}
        </span>
        Membership Verification
    </h1>
    <p class="page-subtitle">AKILIMO Nigeria Association - Member Verification Portal</p>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="chart-card">
            <div class="chart-body text-center">
                {% if not found %}
                    <!-- QR Code Not Found -->
                    <div class="mb-4">
                        <div class="bg-danger rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                             style="width: 80px; height: 80px;">
                            <span class="material-icons text-white" style="font-size: 48px;">error</span>
                        </div>
                        <h2 class="text-danger mb-2">✗ Invalid QR Code</h2>
                        <p class="text-muted">This QR code does not match any membership in our system</p>
                    </div>

                    <div class="alert alert-danger" role="alert">
                        <div class="d-flex align-items-center">
                            <span class="material-icons me-2">warning</span>
                            <div>
                                <strong>Verification Failed:</strong><br>
                                The QR code or verification link is invalid or does not correspond to any registered membership.
                            </div>
                        </div>
                    </div>

                {% elif is_valid %}
                    <!-- Valid Membership -->
                    <div class="mb-4">
                        <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                             style="width: 80px; height: 80px;">
                            <span class="material-icons text-white" style="font-size: 48px;">verified</span>
                        </div>
                        <h2 class="text-success mb-2">✓ Valid Membership</h2>
                        <p class="text-muted">This member has an active subscription with AKILIMO Nigeria Association</p>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <div class="metric-label">Member Name</div>
                                <div class="metric-value" style="font-size: 1.5rem;">{{ member_name }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <div class="metric-label">Certificate Number</div>
                                <div class="metric-value" style="font-size: 1.5rem;">{{ membership.certificate_number }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <div class="metric-label">Membership Type</div>
                                <div class="metric-value" style="font-size: 1.5rem;">{{ membership.get_membership_type_display }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <div class="metric-label">Valid For Year</div>
                                <div class="metric-value" style="font-size: 1.5rem;">
                                    {% if membership.annual_dues_paid_for_year %}
                                        {{ membership.annual_dues_paid_for_year }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if organization %}
                    <div class="row g-4 mb-4">
                        <div class="col-12">
                            <div class="metric-card">
                                <div class="metric-label">Partner Organization</div>
                                <div class="metric-value" style="font-size: 1.5rem;">{{ organization }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="alert alert-success" role="alert">
                        <div class="d-flex align-items-center">
                            <span class="material-icons me-2">info</span>
                            <div>
                                <strong>Membership Status:</strong> Active and Valid<br>
                                <small>This verification was completed on {{ "now"|date:"M d, Y - H:i" }}</small>
                            </div>
                        </div>
                    </div>

                {% else %}
                    <!-- Membership Found But Not Active -->
                    <div class="mb-4">
                        <div class="bg-{{ status_class }} rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                             style="width: 80px; height: 80px;">
                            <span class="material-icons text-white" style="font-size: 48px;">
                                {% if status_class == 'warning' %}warning{% else %}cancel{% endif %}
                            </span>
                        </div>
                        <h2 class="text-{{ status_class }} mb-2">{{ status_message }}</h2>
                        <p class="text-muted">This membership is registered but not currently active</p>
                    </div>

                    <!-- Show member info anyway -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <div class="metric-label">Member Name</div>
                                <div class="metric-value" style="font-size: 1.5rem;">{{ member_name }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <div class="metric-label">Certificate Number</div>
                                <div class="metric-value" style="font-size: 1.5rem;">{{ membership.certificate_number }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="metric-card">
                                <div class="metric-label">Membership Type</div>
                                <div class="metric-value" style="font-size: 1.5rem;">{{ membership.get_membership_type_display }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-card">
                                <div class="metric-label">Status</div>
                                <div class="metric-value" style="font-size: 1.5rem;">
                                    <span class="badge bg-{{ status_class }}">{{ status_message }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-{{ status_class }}" role="alert">
                        <div class="d-flex align-items-center">
                            <span class="material-icons me-2">info</span>
                            <div>
                                {% if status_class == 'danger' %}
                                    <strong>Membership Expired:</strong> This member's subscription for {{ membership.annual_dues_paid_for_year }} has expired.
                                {% elif status_class == 'warning' %}
                                    <strong>Action Required:</strong> This member needs to complete annual dues payment to activate full membership benefits.
                                {% else %}
                                    <strong>Inactive:</strong> This membership is currently inactive.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="mt-4 pt-4 border-top">
                    <h6>About AKILIMO Nigeria Association</h6>
                    <p class="text-muted small">
                        AKILIMO Nigeria Association is dedicated to improving cassava production and 
                        agricultural practices across Nigeria through training, technology transfer, 
                        and sustainable farming methods.
                    </p>
                    
                    <div class="d-flex justify-content-center gap-3 mt-3">
                        <a href="{% url 'dashboard:home' %}" class="btn btn-outline-secondary">
                            <span class="material-icons me-2">home</span>
                            Visit Dashboard
                        </a>
                        {% if not user.is_authenticated %}
                        <a href="{% url 'dashboard:register' %}" class="btn btn-primary">
                            <span class="material-icons me-2">person_add</span>
                            Join ANA
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Security Notice -->
<div class="row justify-content-center mt-4">
    <div class="col-lg-8">
        <div class="alert alert-info" role="alert">
            <div class="d-flex align-items-start">
                <span class="material-icons me-2" style="margin-top: 2px;">security</span>
                <div>
                    <strong>Security Notice:</strong><br>
                    <small>
                        This verification system uses QR codes with unique identifiers to ensure authenticity. 
                        Always verify membership through this official portal. If you suspect fraudulent use, 
                        please contact ANA support immediately.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh verification status every 30 seconds for active sessions
    {% if is_valid %}
    setInterval(function() {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                // Check if membership is still valid
                if (html.includes('Invalid Membership')) {
                    location.reload();
                }
            })
            .catch(error => console.log('Verification check failed:', error));
    }, 30000);
    {% endif %}
</script>
{% endblock %}